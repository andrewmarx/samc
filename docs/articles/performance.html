<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Performance • samc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Performance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">samc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/article-circuit-theory.html">Circuit Theory</a></li>
    <li><a class="dropdown-item" href="../articles/article-computation-methods.html">Computation Methods</a></li>
    <li><a class="dropdown-item" href="../articles/article-models.html">Models</a></li>
    <li><a class="dropdown-item" href="../articles/performance.html">Performance</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Parallel Computing</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><a class="dropdown-item" href="../articles/code-snippets.html">Code Snippets</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-data" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Data</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-data">
<li><a class="dropdown-item" href="../articles/data-disconnected.html">Disconnected Data</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/tutorial-basic.html">Basic Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial-locations.html">Locations</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial-ggplot.html">ggplot Visualization</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial-temporal.html">Temporal Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial-animations.html">Animations</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial-multiple-absorption.html">Multiple Absorption</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/example-coinflip.html">Coin Flip</a></li>
    <li><a class="dropdown-item" href="../articles/example-maze-part1.html">Maze (Part 1)</a></li>
    <li><a class="dropdown-item" href="../articles/example-maze-part2.html">Maze (Part 2)</a></li>
    <li><a class="dropdown-item" href="../articles/example-maze-part3.html">Maze (Part 3)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/andrewmarx/samc"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Performance</h1>
                        <h4 data-toc-skip class="author">Andrew
Marx</h4>
            
            <h4 data-toc-skip class="date">2024-10-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/andrewmarx/samc/blob/HEAD/vignettes/performance.Rmd" class="external-link"><code>vignettes/performance.Rmd</code></a></small>
      <div class="d-none name"><code>performance.Rmd</code></div>
    </div>

    
    
<p><em>Note: This document has not been updated with information on the
convolution method</em></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document provides details about the different performance
aspects of the package. There are two general issues users should be
aware of: computation time and memory (RAM) usage.</p>
<p>Computation time is the more straightforward of the two. Basically,
as the size of the landscape data increases, the amount of time it takes
the calculations to run will also increase. Additionally, many functions
have a time parameter for calculating short-term metrics. As the time
parameter increases, users should expect a proportional increase in
computation time (with an important caveat discussed below). A
recommended strategy for users is to initially use low resolution
version of their landscape data and low time inputs for initially
writing and verifying their scripts. This allows users to incrementally
test things until they are satisfied everything is working correctly
without needing to wait long periods of time for testing. Then, once
ready, they can start using their final inputs, or even first
incrementally increasing the size of the data and time parameters as a
way to gauge how long their final analysis will take to complete.</p>
<p>The more complex issue is RAM usage. All of the calculations involve
matrix calculations that can consume large amounts of memory. In some
cases, the calculations can be optimized to avoid the more memory
intensive calculations, but in other cases it is unavoidable, and will
limit how some functions in the package can be used. It is important for
users to be aware of the limitations of each function they wish to use.
Failing to do so may result in excessive RAM utilization. In some cases,
the analysis may still run by using the hard drive as additional RAM,
but this will slow the analysis by one to three orders of magnitude, and
can cause disk wear that is particularly detrimental to solid state
drives (SSDs). Otherwise, the analysis will likely crash R, potentially
causing loss of work. Writing the initial analysis using a scaled down
versions of the user’s landscape data, and then later incrementally
increasing the resolution is one approach for determining what is
possible to run on a user’s system.</p>
</div>
<div class="section level2">
<h2 id="transition-matrix">Transition Matrix<a class="anchor" aria-label="anchor" href="#transition-matrix"></a>
</h2>
<p>All of the calculations performed by the package make use of a
transition matrix generated using the landscape data. Technically, the
size of the transition matrix grows quadratically with the number of
cells in the landscape data, meaning that it can quickly consume a
computer’s available memory (RAM). The following figure illustrates
this, where even a million landscape cells (a 1000x1000 raster without
any missing data) requires ~7500 GB of RAM, about 1000x what is
typically available in modern consumer computers.</p>
<p><img src="performance_files/figure-html/fig1-1.png" width="624" style="display: block; margin: auto;"></p>
<p>Fortunately, the initial transition matrix is sparse (it contains the
value <code>0</code> in the majority of its cells). This allows the way
it is stored in RAM to be optimized so that the amount of memory it
consumes only grows linearly with the number of cells in the landscape
data. In practice, this means the transition matrix takes up
significantly less RAM. Using a 1000x1000 landscape raster (one million
landscape cells) again as an example, the transition matrix can be
condensed down to less than 0.15 GB of RAM.</p>
<p><img src="performance_files/figure-html/fig2-1.png" width="624" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="calculations">Calculations<a class="anchor" aria-label="anchor" href="#calculations"></a>
</h2>
<p>Creating a large transition matrix is no longer the limiting factor
in terms of memory, but issues still arise when the transition matrix is
used in calculations. Some calculations involving the transition matrix,
such as calculating the inverse, will produce a dense matrix that cannot
be stored in a similarly optimized manner. Instead, the dense matrix
will have the same memory requirement as the first figure above. These
calculations quickly become impractical with even moderately-low amounts
of landscape data. The following figure illustrates how many landscape
cells could be practical with consumer hardware when these calculations
are involved. This is under <em>ideal</em> circumstances; in practice,
more than one dense matrix may need to be in memory at the same time to
perform some calculations.</p>
<p><img src="performance_files/figure-html/fig3-1.png" width="624" style="display: block; margin: auto;"></p>
<p>Many of the equations in the SAMC paper perform these calculations.
In some cases it is completely unavoidable. Fortunately, in other cases,
it is possible to refactor the equations to avoid these particular
calculations, or to use other math techniques and tools that limits
their downside.</p>
</div>
<div class="section level2">
<h2 id="solvers">Solvers<a class="anchor" aria-label="anchor" href="#solvers"></a>
</h2>
<p>There are many different algorithms for solving systems of linear
equations on computers. The most straightforward are direct solvers,
which use a sequence of operations to deliver an exact solution (not
accounting for rounding limitations of hardware). Iterative solvers
generate a sequence of improving approximate solutions until some
criteria is met (e.g., max time, max number of iterations, min
tolerance, etc). In the case of transition matrices generated from
raster data, direct solvers appear to generally be significantly faster,
but they require a large amount of memory in the process. In contrast,
iterative solvers appear to be slower in general (depending on the
structure of the data, they might be faster in rare situations), but are
substantially more memory efficient.</p>
<p>Prior to version 3.0.0, the samc package always used a direct solver.
As of version 3.0.0, the direct solver is still used by default, but now
<code>samc-class</code> objects can now be switched between the direct
solver and an iterative solver. In general, the direct solver should be
used where possible, and the iterative solver should be used when the
problem cannot be solved within the memory constraints of the system.
The iterative solver in samc runs until the error of the result is
within the tolerance of the machine precision; in other words the
iterative solver should have 15-16 digits of precision for most modern
computers, which is a limitation of the direct solver as well.</p>
<p>Not all metrics in samc depend on linear solvers; of the short-term
metrics, only <code><a href="../reference/dispersal.html">dispersal()</a></code> will be affected by the choice of
solver.</p>
</div>
<div class="section level2">
<h2 id="short-term-metrics">Short-term Metrics<a class="anchor" aria-label="anchor" href="#short-term-metrics"></a>
</h2>
<p>The short-term metrics (functions where a number of time steps is
specified) are expected to have a run time that increases linearly with
the number of time steps (as seen in the benchmarks below). Currently, a
limitation in the way numbers are stored in computer hardware is causing
these calculations to slow down substantially with large time steps
(~47000 on one test computer). Until a suitable workaround is
identified, users are recommended to start their analyses with smaller
numbers and increase them incrementally. Plotting these incremental
results may reveal that a large number of time steps is not necessary in
order for the results to stabilize for some/all short-term metrics.</p>
</div>
<div class="section level2">
<h2 id="special-cases">Special Cases<a class="anchor" aria-label="anchor" href="#special-cases"></a>
</h2>
<div class="section level4">
<h4 id="dispersalsamc-origin-dispersalsamc-init">dispersal(samc, origin) &amp; dispersal(samc, init)<a class="anchor" aria-label="anchor" href="#dispersalsamc-origin-dispersalsamc-init"></a>
</h4>
<p>These metrics have been optimized for memory usage, but due to the
requirement of calculating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">diag(F)</annotation></semantics></math>,
remain substantially slower than solutions for metrics. Additionally, as
the number of transient states increases, the time to compute the result
increases quadratically. Once calculated, however, the result of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">diag(F)</annotation></semantics></math>
is cached and reused in future runs of these metrics. So only the first
time running these metrics for a particular samc-class object will be
slow.</p>
<p>Given how slow calculating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">diag(F)</annotation></semantics></math>
can be, progress updates are provided during different stages of the
calculation. The first stage involves a matrix decomposition that
generally will take less than a few minutes, but could take several
minutes with large datasets. The second stage is by far the most time
consuming part of the calculation, and a time estimate will be
periodically updated to give users a rough estimate of how long it will
take to complete. The first few time estimates tend to be inflated due
to the low sampling time, but will improve with each update. During the
calculation, other software running on the computer can affect how fast
the calculation runs, and in turn, lead to changes in time predictions.
Once
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">diag(F)</annotation></semantics></math>
is calculated, obtaining the final result for these metrics will take an
amount of time comparable to other metrics.</p>
<p>As of v1.5.0, these functions support parallel computing to reduce
the time required for calculating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">diag(F)</annotation></semantics></math>.
See the <a href="parallel.html">Parallel Computing</a> vignette for
details.</p>
</div>
</div>
<div class="section level2">
<h2 id="benchmarks">Benchmarks<a class="anchor" aria-label="anchor" href="#benchmarks"></a>
</h2>
<p>This section includes automated benchmarks for each method that has
been optimized to avoid memory issues. This information is primarily for
prioritizing future optimizations, but is published in case some users
find it helpful. The benchmarking approach is crude and there may be
occasional outliers as a result. Computation time could vary quite a lot
with different hardware.</p>
<div class="section level4">
<h4 id="overall-performance">Overall Performance<a class="anchor" aria-label="anchor" href="#overall-performance"></a>
</h4>
<p><em>v3.0.0: needs to be updated</em></p>
<p>Performance of each of the functions relative to number of landscape
cells. For short-term metrics, the number of time steps was set to
<code>10000</code>.</p>
<p><img src="img/bt.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="overall-memory-usage">Overall Memory Usage<a class="anchor" aria-label="anchor" href="#overall-memory-usage"></a>
</h4>
<p><em>Removed. The profiling tools in R do not measure the memory
consumed by native code. In other words, the figures only showed the
memory used by the R parts of the code, not the C++ parts, which caused
the memory consumption figures to dramatically underestimate memory
usage. An external tool has been identified and memory benchmarks will
be redone in the future.</em></p>
</div>
<div class="section level4">
<h4 id="temporal-performance">Temporal Performance<a class="anchor" aria-label="anchor" href="#temporal-performance"></a>
</h4>
<p><em>v3.0.0: needs to be updated</em></p>
<p>Performance of each of the short-term metrics for varying number of
time steps. The number of landscape cells used for this benchmark was
500,000.</p>
<p><img src="img/btt.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="temporal-memory-usage">Temporal Memory Usage<a class="anchor" aria-label="anchor" href="#temporal-memory-usage"></a>
</h4>
<p><em>Removed. The profiling tools in R do not measure the memory
consumed by native code. In other words, the figures only showed the
memory used by the R parts of the code, not the C++ parts, which caused
the memory consumption figures to dramatically underestimate memory
usage. An external tool has been identified and memory benchmarks will
be redone in the future.</em></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Marx.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
